name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: swift-actions/setup-swift@v2

      - name: Build universal binary
        run: |
          swift build -c release --arch arm64
          swift build -c release --arch x86_64
          lipo -create \
            .build/arm64-apple-macosx/release/VirtualScreen \
            .build/x86_64-apple-macosx/release/VirtualScreen \
            -output VirtualScreen-universal
          lipo -info VirtualScreen-universal

      - name: Package app bundle
        run: |
          APP="VirtualScreen.app"
          CONTENTS="$APP/Contents"
          MACOS="$CONTENTS/MacOS"
          RESOURCES="$CONTENTS/Resources"
          mkdir -p "$MACOS" "$RESOURCES"
          cp VirtualScreen-universal "$MACOS/VirtualScreen"
          cp Sources/VirtualScreen/Info.plist "$CONTENTS/Info.plist"
          cp Resources/AppIcon.icns "$RESOURCES/AppIcon.icns"
          codesign --force --deep -s - "$APP"

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "VirtualScreen" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "VirtualScreen.app" 150 190 \
            --app-drop-link 450 190 \
            --hide-extension "VirtualScreen.app" \
            --no-internet-enable \
            VirtualScreen.dmg \
            VirtualScreen.app

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: VirtualScreen.dmg
          generate_release_notes: true
          body: |
            ## Install
            1. Download **VirtualScreen.dmg**
            2. Open the DMG and drag **VirtualScreen** to Applications
            3. Launch from Applications

            > **macOS Gatekeeper:** The app is not notarized. On first launch, right-click and select **Open**. If you see "damaged and can't be opened", run: `xattr -cr /Applications/VirtualScreen.app`
